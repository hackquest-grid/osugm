#!/bin/bash

export OSUGM_ROOT=$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)
cd $OSUGM_ROOT
[ "$OSUGM_LIB" ] || export OSUGM_LIB="$OSUGM_ROOT/lib"
source "$OSUGM_LIB/helpers.sh"
source "$OSUGM_LIB/osugm.sh"

check_test () {
    test "$@" &> /dev/null
    echo "$@ = $?"
}

cmd="$1"
if [[ $cmd == list ]]; then
    ls "$OSUGM_CONF/available"
    exit 0
fi

# ensure a simulator instance name as been provided
export OSUGM_SIMNAME="$2"
if [[ -z $OSUGM_SIMNAME ]]; then
    cat << EOT
$OSUGM {command} {simname} - Controls a simulator instance
Where {simname} is the name of the config directory for that instance
and {command} is one of:
    list    List available simulators (list does not need an instance name)
    init    Create a default configuration from template
    enable  Enable auto start of the simulator when running the grid
    disable Disable auto start of the simulator when running the grid
    direct  Start the simulator without putting it in the tmux session
    start   Start the simulator
    stop    Stop the simulator
    restart stop, then start
    kill    Force stopping the simulator when it does not respond
    status  Get running status
    console Enter the OpenSim console of this instance inth the tmux session
EOT
    exit 1
fi
shift 2

export OSUGM_SIMCONF="$OSUGM_CONF/available/$OSUGM_SIMNAME"
export OSUGM_SIMRUN="$OSUGM_RUN/opensim.$OSUGM_SIMNAME"
mkdir -p "$OSUGM_SIMRUN/log"
msgsim="$OSUGM_SIMNAME"
set_logfile "$OSUGM.$OSUGM_SIMNAME.log"

if [[ $cmd = init ]]; then
    mkdir -p "$OSUGM_SIMCONF/regions" || error "Error creating $OSUGM_SIMCONF/regions"
    log info "Creating files for '$msgsim' instance..."
    [[ -f $OSUGM_SIMCONF/instance.conf ]] || cp -v "$OSUGM_LIB/templates/instance.conf" "$OSUGM_SIMCONF" || exit 1
    [[ -f $OSUGM_SIMCONF/Local.ini ]] || cp -v "$OSUGM_LIB/templates/Local.ini" "$OSUGM_SIMCONF" || exit 1
    [[ -f $OSUGM_CONF/OpenSim.ini ]] || cp -v "$OSUGM_LIB/templates/OpenSim.ini" "$OSUGM_CONF" || exit 1
    log info "Done. Don't forget to edit your new configuration in:\n\t$OSUGM_SIMCONF"
    exit 0
fi

[[ -r $OSUGM_SIMCONF/instance.conf ]] || error "Missing file '$OSUGM_SIMCONF/instance.conf'"
source "$OSUGM_SIMCONF/instance.conf" || error "Loading '$OSUGM_SIMCONF/instance.conf' failed"
[[ -n $OSUGM_SIMPORT ]] || error "Missing variable OSUGM_SIMPORT in '$OSUGM_SIMCONF/instance.conf'"

sim_exists () {
    ps -ef | grep "$OSUGM_MONO OpenSim.exe" | grep "$OSUGM_SIMCONF" | grep -qv grep #&& test -f "$OSUGM_SIMRUN/OpenSim.exe.pid"
}

case "$cmd" in
enable)
    ;;
disable)
    ;;
direct|start)
    if sim_exists; then
        log warn "$msgsim is already running. Use `basename $0` '$OSUGM_SIMNAME' console to view it"
        return 0
    fi

    # allow user overriding logging options
    logconfig="$OSUGM_LIB/conf/OpenSim.exe.config"
    if [[ -f $OSUGM_SIMCONF/OpenSim.exe.config ]]; then
        logconfig="$OSUGM_SIMCONF/OpenSim.exe.config"
    fi

    cmd="env LANG=C $OSUGM_MONO OpenSim.exe \
        -inifile=\"$OSUGM_LIB/conf/OpenSim.ini\" \
        -inidirectory=\"$OSUGM_SIMCONF\" \
        -logconfig=\"$logconfig\""

    if [[ $1 = 'direct' ]]; then
        direct_start $msgsim "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    else
        screen_start $msgsim sim_exists 10 "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    fi
    ;;
stop)
    if ! sim_exists; then
        log warn "$msgsim is not started"
        exit 0
    fi
    if screen_exists "$msgsim"; then
        screen_stop $msgsim sim_exists 60 "$OSUGM_SIMRUN/OpenSim.exe.pid"
    else
        log warn "$msgsim started manually, stop it from the console"
    fi
    ;;
restart)
    $0 stop && $0 start
    ;;
kill)
    kill_pidfile $msgsim "$OSUGM_SIMRUN/OpenSim.exe.pid"
    ;;
status)
    if sim_exists; then
        echo "$msgsim running"
        exit 0
    fi
    echo "$msgsim offline"
    exit 10
    ;;
console)
    screen_attach "$OSUGM_SIMNAME"
    ;;
*)
    # without argument, shows help
    $0
    ;;
esac
