#!/bin/bash

export OSUGM_ROOT=$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)
cd $OSUGM_ROOT
source lib/helpers.sh
source lib/osgum.sh

do_help () {
    cat << EOT
$OSUGM {simname} {command} - Controls a simulator instance
Where {simname} is the name of the config directory for that instance
and {command} is one of:
    enable  Enable auto start of the simulator when running the grid
    disable Disable auto start of the simulator when running the grid
    direct  Start the simulator without putting it in the tmux session
    start   Start the simulator
    stop    Stop the simulator
    restart stop, then start
    kill    Force stopping the simulator when it does not respond
    status  Get running status
    console Enter the OpenSim console of this instance inth the tmux session
EOT
    exit 1
}

# ensure a simulator instance name as been provided
export OSUGM_SIMNAME="$1"
if [[ -z $OSUGM_SIMNAME ]] || [[ $# -lt 2 ]]; then
    do_help
fi
shift

export OSUGM_SIMCONF="$OSUGM_CONF/available/$OSUGM_SIMNAME"
export OSUGM_SIMRUN="$OSUGM_RUN/$OSUGM_SIMNAME"
mkdir -p "$OSUGM_SIMRUN/log"
msgsim="$OSUGM_SIMNAME"

source "$OSUGM_SIMCONF/instance.conf" || error "Missing file '$OSUGM_SIMCONF/instance.conf'"
[[ -n $OSUGM_SIMPORT ]] || error "Missing variable OSUGM_SIMPORT in '$OSUGM_SIMCONF/instance.conf'"

sim_exists () {
    (ps -ef | grep "$OSUGM_MONO OpenSim.exe" | grep -qv grep) && test -f "$OSUGM_SIMRUN/OpenSim.exe.pid"
}

case "$1" in
enable)
    ;;
disable)
    ;;
direct|start)
    if sim_exists; then
        log warn "$msgsim is already running. Use `basename $0` '$OSUGM_SIMNAME' console to view it"
        return 0
    fi

    # allow user overriding logging options
    logconfig="$OSUGM_LIB/conf/OpenSim.exe.config"
    if [[ -f $OSUGM_SIMCONF/OpenSim.exe.config ]]; then
        logconfig="$OSUGM_SIMCONF/OpenSim.exe.config"
    fi

    cmd="env LANG=C $OSUGM_MONO OpenSim.exe \
        -inifile=\"$OSUGM_LIB/conf/OpenSim.ini\" \
        -inidirectory=\"$OSUGM_SIMCONF\" \
        -logconfig=\"$logconfig\""

    echo -n "$MSGSIM starting "
    if [[ $1 = 'direct' ]]; then
        direct_start $msgsim "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    else
        screen_start $msgsim sim_exists 10 "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    fi
    ;;
stop)
    if sim_exists; then
        log warn "$msgsim is not started"
        return 0
    fi
    if screen_exists "$OSUGM_SIMNAME"; then
        screen_stop $msgsim sim_exists 120
    else
        log warn "$msgsim started manually, stop it from the console"
    fi
    ;;
restart)
    $0 stop && $0 start
    ;;
kill)
    kill_pidfile "$OSUGM_SIMRUN/OpenSim.exe.pid"
    ;;
status)
    if sim_exists; then
        echo "$msgsim running"
    else
        echo "$msgsim offline"
    fi
    ;;
console)
    screen_attach "$OSUGM_SIMNAME"
    ;;
*)
    do_help
    ;;
esac
