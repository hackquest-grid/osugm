#!/bin/bash

export OSUGM_ROOT=$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)
cd $OSUGM_ROOT
source lib/helpers.sh
source lib/osgum.sh
set_logfile "$OSUGM.log"

export OSUGM_GRIDRUN="$OSUGM_RUN/grid"
mkdir -p "$OSUGM_GRIDRUN/log"
msgrob='Robust'

robust_exists () {
    (ps -ef | grep "$OSUGM_MONO Robust.exe" | grep -qv grep) && test -f "$OSUGM_GRIDRUN/Robust.exe.pid"
}

case "$1" in
direct|start)
    if robust_exists; then
        log warn "$msgrob is already running. Use `basename $0` console to view it"
        return 0
    fi

    # check user config
    [[ -f "$OSUGM_CONF/Robust.ini" ]] || error "Cannot find user config '$OSUGM_CONF/Robust.ini'"
    [[ -f "$OSUGM_CONF/Database.ini" ]] || error "Cannot find user config '$OSUGM_CONF/Database.ini'"

    # allow user overriding logging options
    logconfig="$OSUGM_LIB/conf/Robust.exe.config"
    if [[ -f $OSUGM_CONF/Robust.exe.config ]]; then
        logconfig="$OSUGM_CONF/Robust.exe.config"
    fi

    cmd="env LANG=C $OSUGM_MONO Robust.exe \
        -inifile=\"$OSUGM_LIB/conf/Robust.ini\" \
        -logconfig=\"$logconfig\""

    if [[ $1 = 'direct' ]]; then
        direct_start $msgrob "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    else
        screen_start $msgrob robust_exists 10 "$OSUGM_EXEC/$OSUGM_OPENSIM/bin" $cmd
    fi
    ;;
stop)
    if robust_exists; then
        log warn "$msgrob is not started"
        exit 0
    fi
    if screen_exists $msgrob; then
        screen_stop $msgrob robust_exists 120
    else
        log warn "$msgrob started manually, stop it from the console"
    fi
    ;;
restart)
    $OSUGM stop && $OSUGM start
    ;;
kill)
    kill_pidfile $msgrob "$OSUGM_GRIDRUN/Robust.exe.pid"
    ;;
status)
    if robust_exists; then
        echo "$msgrob running"
    else
        echo "$msgrob offline"
    fi
    ;;
console)
    screen_attach $msgrob
    ;;
*)
    cat <<EOT
$OSUGM {command} - Controls Robust grid manager
Where {command} is one of:
    direct  Start Robust without putting it in the tmux session
    start   Start Robust
    stop    Stop Robust
    restart stop, then start
    kill    Force stopping Robust when it does not respond
    status  Get running status
    console Enter the Robust console into the tmux session
EOT
    exit 1
esac
