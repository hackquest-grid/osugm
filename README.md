# OpenSim Unix Grid Manager

Set of scripts and configuration for **OpenSim** 0.9.x to manage one **Robust** and all **OpenSim** instances in a centralized way. Using a unique entry point with **screen** and factorized initialization files, it becomes easier to create and upgrade a grid, and manage running simulators.

## Understanding directories

All the configuration is in the `conf` directory and OpenSim provided initialization files are never touched. In fact the whole **Opensim** installation directory can be marked read-only to be sure it is not touched, and ready for an update.

**OSUGM** provided configuration files are in `lib/conf` directory, and should not be touched as well. Your configuration files are only in the `conf` directory to overload global settings.

Files created while instances are running are all in the `run` directory. One directory per **OpenSim** instance, plus the **Robust** one.

**OpenSim** downloaded binaries are in the `opensim` directory. It is possible to use difference versions of **OpenSim** for each instance and **Robust**, or use the same everywhere. It is very flexible :)

### Binaries

All commands are in the `bin` directory. The simpliest way to run your grid, once it is configured, is to run the `bin/gridctl` script, which starts **Robust** and all enabled **OpenSim** instances. **Robust** and **OpenSim** instances can also be controlled separately via `bin/robustctl` and `bin/simctl` respectively.

### Configuration

The main settings for the grid are stored in the `conf/osugm.conf` file. It's a bash script defining some variables used globally.
Other configuration files can be generated by the scripts.

#### conf/available/

This directory contains one directory per configured **OpenSim** instance.

#### conf/enabled/

This directory is a set of symlinks to the `conf/available/` directory for each enabled **OpenSim** instance. `bin/gridctl` will use those symlinks to know which instances to manage with the grid as a whole.

#### Local settings

**OSUGM** provides its own configuration files that should not be touched.
You can finegrain alter settings with those in the `conf` directory:

* `conf/osgum.conf` your **OSUGM** main configuration file
* `conf/Robust.ini` your local **Robust** settings
* `conf/Database.ini` your **Robust** database access settings
* `conf/Robust.exe.config` logging options (optionnal)
* `conf/OpenSim.ini` your local simulator settings, shared for all instances
* `conf/available/{inst}/instance.conf` local overrides from `conf/osugm.conf` (for example, to use a specific **OpenSim** version)
* `conf/available/{inst}/*.ini` your local simulator settings for a specific instance (all ini files in this directory are parsed)
* `conf/available/{inst}/OpenSim.exe.config` logging options (optionnal)
* `conf/available/{inst}/regions/*.ini` region initialization files

#### Global settings

Among files you should never touch, here is a description to have a quick sight on how things are organized.

For **Robust**:
* `lib/conf/Robust.ini` main configuration file, includes your `conf/Robust.ini` and `conf/Database.ini`
* `lib/conf/Robust.exe.config` used if `conf/Robust.exe.config` does not exist

For **OpenSim**:
* `lib/conf/OpenSim.ini` main configuration file for all instances, includes your `conf/OpenSim.ini` and uses `conf/available/{inst}` directory as modular configuration (parsing all `.ini` in it)
* `lib/conf/OpenSim.exe.config` used if `conf/available/{inst}/OpenSim.exe.config` does not exist

### Runtime directory

The `run` directory contains all *variable* files and directories. It's organized per instance:
* `run/grid` contains **Robust** runtime files
* `run/opensim.{instance}` (with *{instance}* the instane name) contains all **OpenSim** runtime files for one instance

## Usage explained

Distribution is made of 2 classic directories:
* `bin` contains runnable scripts
* `lib` content needed by scripts

Other directories are generated during the setup. By default, **OSUGM** is configured to be in its own directory, using it as a root for user files. By exporting some variables it's possible to give it references to other directories:
* `OSUGM_CONF` where your configuration is
* `OSUGM_BIN` **OSUGM** commands
* `OSUGM_LIB` a different directory for **OSUGM** support files (for example to use it in a standard Unix way)
* `OSUGM_EXEC` where Opensim releases are put
* `OSUGM_RUN` runtime directory (your grid/opensim user files)

### Setup OSUGM

```sh
bin/gridctl init
```
That will generate the basic set of directories and files neeed by **OSUGM** (you can change them, see above).
* `conf/` your configuration directory
* `conf/osugm.conf` the central configuration file
* `conf/Database.ini` your Robust database access
* `conf/Robust.ini` almost empty file for overriding Robust settings
* `opensim/` where you put your OpenSim distributions
* `run/` all files generated by Robust, OpenSim and **OSUGM** itself (log files for instance)

### Download and extract Opensim

You need of course at least one distribution of **OpenSim** available in the `opensim` directory (or any other directory if you changed `$OSUGM_EXEC`). Download the one you need, extract it in the `opensim` directory, ensuring the distribution respects the standard Opensim schema (everything contained in a `bin` directory).

```sh
$ cd path/to/osugm
$ cd opensim
$ tar -axf path/to/downloaded/opensim-0.9.2.0.tar.xz
$ ls opensim-0.9.2.0
addon-modules
bin
doc
...
```

### Configure your grid

Edit `conf/osugm.conf`. This is a **bash** shell script exporting a few variables:
* **OSUGM_LOGGING** if `true`, will log every command executed by **OSUGM** scripts in log files named after the script (`gridctl.log`, `robustctl.log`, `simctl.{instname}.log`)
* **OSUGM_NAME** is the main nickname of your grid. It should not contain any space or special character
* **OSUGM_FULLNAME** is the display name of your grid. By default it equals `$OSUGM_NAME`
* **OSUGM_HOST** is the hostname of the machine running the grid. Note that it **must be publicly accessible** from internet DNS servers. If you don't have a public hostname (with your own domain name, or some dynamic DNS), then you **MUST** put your **public IP address** there
* **OSUGM_SCHEME** should be left to `http` for now. It's in prevision for the future, when TLS will have been tested correctly.
* **OSUGM_PUBLICPORT** is the public port of your grid, that is, an opened port for internet on TCP. This, with **OSUGM_HOST**, is used to connect to your grid.
* **OSUGM_PRIVATEPORT** is the internal port of your grid, used by **Opensim** instances to reach grid services. If you plan to have **Opensim** instances outside of your local network, this port should also be opened for internet on TCP.
* **OSUGM_MONO** defaults to the system wide **Mono** executable. If you want to run with a specific version, you can specify its path here
* **OSUGM_OPENSIM** is the default **OpenSim** distribution used. Set here the name of the directory created on **OpenSim** distribution extraction. It will be used by **Robust** and all instances of **OpenSim** by default, but can be overridden when needed.
* **Other shell exports** can be set to adapt to your environment. Some are already set by default, you can change or comment them out as you need

### Database

**Robust** needs a **MySQL** database (or compatible, like **MariaDB**). **OSUGM** does not handle setting up a database for you, so refer to your GNU/Linux distribution for that. You must ensure one MySQL user exists and has full rights to one database.

You can then edit `conf/Database.ini`. The generated one uses `opensim` for the *user* and the *database name*. Along the *hostname* and *password*, set those to your local setup.

### Run Robust

You can now make a first startup of your grid service
```sh
$ bin/robustctl start
info Robust starting . running
```

As **OSUGM** uses *screen* to execute programs, **Robust** is started in the background. You can go to its console at anytime with
```sh
$ bin/robustctl console
```
Once there, you can do `Ctrl+D` to detach from this screen console (take time to get familiar with screen if you don't know it yet).

To stop **Robust**
```sh
$ bin/robustctl stop
Robust stopping. stopped
```

### Configure your first simulator

The process is similar to the grid setup:
1. initialize default configuration and runtime files
2. edit configuration
3. run OpenSim

To generate default configuration files, you must first decide of an instance name for your simulator. **OSUGM** can manage several instances of **OpenSim** running on the same machine. You can for example call it `default` or `welcome`, or with a numeral scheme like `01`, `02`, etc.. We will use `instname` for illustration here.

```sh
$ bin/simctl init instname
```
This generates several files in `conf/available/instname/`. The first one is `instance.conf`, and is the equivalent to `osugm.conf`, dedicated to this instance of OpenSim.

You can for example change **shell** and **Mono** settings, and override some global variables, like `$OSUGM_OPENSIM` to use a specific **OpenSim** distribution.

The most important variable to setup is `OSUGM_SIMPORT`. It represents the HTTP port used by **OpenSim** to listen on (for various services like LSL HTTP servers). It will be used to set the `http_listener_port` of the `[Network]` section of **OpenSim** configuration.

You also have a `Local.ini` which is empty by default, but will be included for **OpenSim** after all others. You can put your custom settings there. In fact, you can add as many `.ini` files as you want in the `conf` directory, they will all be read.

An additional and important generated file is `conf/OpenSim.ini`. This is one you can customize and is read by all instances of **OpenSim**, making shared configuration easier. By default, it sets up the simulator database connector (a simple SQLite database in the runtime directory).

`Regions.ini` files will be stored in `conf/available/instname/regions/` when you will create your first region in **OpenSim**. Talking about that, let's do it!

```sh
$ bin/simctl start instname
info instname starting . running
```

Like for Robust, you can get to the console with
```sh
$ bin/simctl console instname
```
You should there see the **OpenSim** prompt to create a region. Refer to **OpenSim** documentation for this. Just be sure:
* to use a DNS hostname publicly accessible from internet for the **External Hostname**, or the public IP if a DNS is not possible
* set an **Internal Port** that is opened for UDP on incoming requests

A last step: your grid needs a default region. So in `conf/Robust.ini` change the commented line to match your region name:
```ini
[GridService]

    Region_Welcome = "DefaultRegion, FallbackRegion"
```

To stop the simulator, simply do
```sh
$ bin/simctl stop instname
instname stopping. stopped
```

### The grid as a whole

Instead of starting and stopping **Robust** and all the simulator separately, you can use the `gridctl` script, which makes calls to `robustctl` and `simctl`.

To make simulators known to the grid, you need to *enable* them. That way you have control on the automatically run instances.
```sh
$ bin/gridctl enable instname
info 'instname' instance enabled for running with grid
```

Starting the grid (**Robust** and all enabled instances) is then as simple as
```sh
$ bin/gridctl start
info Robust starting . running
info instname starting . running
```

And stopping works the same way
```sh
$ bin/gridctl stop
instname stopping. stopped
Robust stopping. stopped
```

## Going further

**OSUGM** is made of 3 commands:
* **robustctl** controlling **Robust**
* **simctl** controlling simulator instances
* **gridctl** controlling both **Robust** through `robustctl` and all *enabled* simulators through `simctl`

You can can a quick help of available actions for each command invoking them without parameter.

### Using the Unix directory layout

Let's say you want to integrate **OSUGM** in your system, for example in `/usr/local`.

```

root # mkdir -p /etc/osugm
root # mkdir -p /usr/local/share/osugm
root # mkdir -p /var/lib/osugm
root # cp bin/* /usr/local/bin
root # cp -r lib/* /usr/loca/share/osugm
```

Edit your global environment variables file (`/etc/environment` or `/etc/profile` or `/etc/profile.d/osugm.sh`):

```sh
export OSUGM_CONF="/etc/osugm"
export OSUGM_BIN="/usr/local/bin"
export OSUGM_LIB="/usr/local/share/osugm"
export OSUGM_EXEC="/var/lib/osugm/opensim"
export OSUGM_RUN="/var/lib/osugm/run"
```

The only exception to standard directory layout is for log files that cannot be put in `/var/log/` and must stay in the *run* directory for now.
